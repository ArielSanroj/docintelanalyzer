"""
Script de prueba para el sistema RAG-Anything mejorado.
Demuestra todas las capacidades multimodales, contextuales y de grafo de conocimiento.
"""

import logging
import os
import sys
from pathlib import Path

# Configurar logging
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

def test_rag_anything_system():
    """Prueba completa del sistema RAG-Anything."""
    
    try:
        # Importar el sistema RAG-Anything
        from rag_anything_integration import RAGAnythingSystem
        
        print("üöÄ Inicializando sistema RAG-Anything...")
        
        # Inicializar sistema con todas las capacidades
        rag_system = RAGAnythingSystem(
            embedding_model="all-MiniLM-L6-v2",
            vlm_model="nvidia/llama-3.2-vision-instruct",
            enable_vision=True,
            enable_context_awareness=True,
            enable_knowledge_graph=True
        )
        
        print("‚úÖ Sistema RAG-Anything inicializado correctamente")
        
        # Mostrar capacidades del sistema
        capabilities = rag_system.get_system_capabilities()
        print("\nüìã Capacidades del sistema:")
        for key, value in capabilities.items():
            print(f"  - {key}: {value}")
        
        # Procesar un documento de ejemplo
        print("\nüìÑ Procesando documento de ejemplo...")
        
        # Crear contenido de ejemplo con diferentes tipos de informaci√≥n
        sample_content = """
        # Informe de Proyecto de Investigaci√≥n
        
        ## Resumen Ejecutivo
        Este proyecto de investigaci√≥n se desarroll√≥ entre enero y diciembre de 2024, 
        bajo la direcci√≥n del Dr. Mar√≠a Gonz√°lez en la Universidad de Barcelona.
        
        ## Objetivos
        Los objetivos principales incluyen:
        1. Desarrollar un sistema de an√°lisis multimodal
        2. Implementar capacidades de visi√≥n artificial
        3. Crear un grafo de conocimiento integrado
        
        ## Metodolog√≠a
        La metodolog√≠a empleada combina t√©cnicas de:
        - Procesamiento de lenguaje natural
        - Visi√≥n por computadora
        - Aprendizaje autom√°tico
        
        ## Resultados
        Los resultados muestran una mejora del 25% en la precisi√≥n del sistema.
        
        ## Conclusiones
        El sistema desarrollado demuestra capacidades avanzadas de procesamiento multimodal.
        """
        
        # Procesar el contenido
        rag_system.process_document("sample_document.txt", sample_content)
        
        # Mostrar estad√≠sticas del documento
        doc_stats = rag_system.get_document_analysis()
        print("\nüìä Estad√≠sticas del documento:")
        print(f"  - Chunks totales: {doc_stats['document_stats']['total_chunks']}")
        print(f"  - Tipos de contenido: {doc_stats['document_stats']['content_types']}")
        
        # Probar diferentes tipos de consultas
        test_queries = [
            "¬øCu√°les son los objetivos del proyecto?",
            "¬øQui√©n dirigi√≥ el proyecto?",
            "¬øQu√© metodolog√≠a se utiliz√≥?",
            "¬øCu√°les fueron los resultados obtenidos?",
            "¬øQu√© universidad particip√≥ en el proyecto?"
        ]
        
        print("\nüîç Probando consultas...")
        
        for i, query in enumerate(test_queries, 1):
            print(f"\n--- Consulta {i}: {query} ---")
            
            # Procesar consulta con todas las capacidades
            response = rag_system.query_document(
                query=query,
                top_k=3,
                use_context_awareness=True,
                use_visual_analysis=True,
                use_knowledge_graph=True
            )
            
            print(f"Respuesta: {response.answer[:200]}...")
            print(f"Confianza: {response.confidence_score:.3f}")
            print(f"Chunks relevantes: {len(response.relevant_chunks)}")
            
            if response.contextual_analysis:
                print(f"An√°lisis contextual: {len(response.contextual_analysis.temporal_context)} elementos temporales")
            
            if response.knowledge_graph_insights:
                print(f"Entidades relevantes: {len(response.knowledge_graph_insights['relevant_entities'])}")
        
        # Mostrar an√°lisis del grafo de conocimiento
        if rag_system.knowledge_graph_system:
            print("\nüß† An√°lisis del grafo de conocimiento:")
            kg_stats = rag_system.knowledge_graph_system.get_entity_statistics()
            print(f"  - Entidades totales: {kg_stats['total_entities']}")
            print(f"  - Relaciones totales: {kg_stats['total_relations']}")
            print(f"  - Tipos de entidades: {kg_stats['entity_types']}")
        
        # Exportar grafo de conocimiento
        print("\nüíæ Exportando grafo de conocimiento...")
        kg_export = rag_system.export_knowledge_graph("json")
        if kg_export:
            print("‚úÖ Grafo de conocimiento exportado exitosamente")
            # Guardar en archivo
            with open("knowledge_graph.json", "w", encoding="utf-8") as f:
                f.write(kg_export)
            print("üìÅ Guardado en knowledge_graph.json")
        
        # Generar visualizaci√≥n del grafo
        print("\nüé® Generando visualizaci√≥n del grafo...")
        graph_viz = rag_system.visualize_knowledge_graph(max_nodes=20)
        if graph_viz:
            print("‚úÖ Visualizaci√≥n generada exitosamente")
            # Guardar como imagen
            import base64
            with open("knowledge_graph.png", "wb") as f:
                f.write(base64.b64decode(graph_viz))
            print("üìÅ Guardado en knowledge_graph.png")
        
        print("\nüéâ Prueba del sistema RAG-Anything completada exitosamente!")
        
        return True
        
    except ImportError as e:
        print(f"‚ùå Error de importaci√≥n: {e}")
        print("üí° Aseg√∫rate de que todas las dependencias est√©n instaladas")
        return False
        
    except Exception as e:
        print(f"‚ùå Error durante la prueba: {e}")
        logger.exception("Error detallado:")
        return False

def test_multimodal_processing():
    """Prueba espec√≠fica del procesamiento multimodal."""
    
    try:
        from multimodal_rag_system import MultimodalRAGSystem
        
        print("\nüî¨ Probando procesamiento multimodal...")
        
        # Crear sistema multimodal
        multimodal_rag = MultimodalRAGSystem(
            embedding_model="all-MiniLM-L6-v2",
            enable_vision=True
        )
        
        # Contenido con diferentes tipos de informaci√≥n
        multimodal_content = """
        # Documento Multimodal de Prueba
        
        ## Texto Principal
        Este es un documento que contiene diferentes tipos de contenido.
        
        ## Tabla de Datos
        | Producto | Precio | Cantidad |
        |----------|--------|----------|
        | Laptop   | $1200  | 50       |
        | Mouse    | $25    | 100      |
        | Teclado  | $75    | 80       |
        
        ## Ecuaci√≥n Matem√°tica
        La f√≥rmula para calcular el √°rea de un c√≠rculo es: A = œÄ √ó r¬≤
        
        ## Informaci√≥n Temporal
        El proyecto se desarroll√≥ entre el 15 de marzo de 2024 y el 30 de noviembre de 2024.
        
        ## Informaci√≥n Espacial
        La oficina principal se encuentra en Madrid, Espa√±a, cerca del centro de la ciudad.
        """
        
        # Procesar documento
        multimodal_rag.process_document("multimodal_test.txt", multimodal_content)
        
        # Mostrar estad√≠sticas
        stats = multimodal_rag.get_document_stats()
        print(f"‚úÖ Documento procesado: {stats['total_chunks']} chunks")
        print(f"üìä Tipos de contenido: {stats['content_types']}")
        
        # Probar consultas
        queries = [
            "¬øCu√°l es el precio de la laptop?",
            "¬øCu√°l es la f√≥rmula del √°rea del c√≠rculo?",
            "¬øD√≥nde se encuentra la oficina principal?",
            "¬øCu√°ndo se desarroll√≥ el proyecto?"
        ]
        
        for query in queries:
            result = multimodal_rag.retrieve_multimodal(query, top_k=2)
            print(f"\nüîç Consulta: {query}")
            print(f"   Chunks encontrados: {len(result.chunks)}")
            print(f"   Tipos: {[chunk.content_type for chunk in result.chunks]}")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Error en prueba multimodal: {e}")
        return False

def test_context_awareness():
    """Prueba espec√≠fica del procesamiento contextual."""
    
    try:
        from context_aware_processor import ContextAwareProcessor
        
        print("\nüß† Probando procesamiento contextual...")
        
        # Crear procesador contextual
        context_processor = ContextAwareProcessor()
        
        # Crear chunks de ejemplo
        class MockChunk:
            def __init__(self, content, chunk_id):
                self.content = content
                self.chunk_id = chunk_id
        
        chunks = [
            MockChunk("El proyecto comenz√≥ en enero de 2024 y termin√≥ en diciembre del mismo a√±o.", 0),
            MockChunk("La oficina principal est√° ubicada en Barcelona, Espa√±a.", 1),
            MockChunk("Debido a la pandemia, el trabajo se realiz√≥ de forma remota.", 2),
            MockChunk("El Cap√≠tulo 1 describe la metodolog√≠a utilizada.", 3),
            MockChunk("La definici√≥n de RAG es Retrieval-Augmented Generation.", 4)
        ]
        
        # Analizar contexto
        query = "¬øCu√°ndo y d√≥nde se desarroll√≥ el proyecto?"
        contextual_analysis = context_processor.analyze_context(chunks, query)
        
        # Mostrar resultados
        print(f"‚úÖ An√°lisis contextual completado")
        print(f"üìÖ Elementos temporales: {len(contextual_analysis.temporal_context)}")
        print(f"üìç Elementos espaciales: {len(contextual_analysis.spatial_context)}")
        print(f"üîó Elementos causales: {len(contextual_analysis.causal_context)}")
        print(f"üìö Elementos jer√°rquicos: {len(contextual_analysis.hierarchical_context)}")
        print(f"üí° Elementos sem√°nticos: {len(contextual_analysis.semantic_context)}")
        
        # Generar resumen contextual
        summary = context_processor.generate_contextual_summary(contextual_analysis)
        print(f"\nüìã Resumen contextual: {summary}")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Error en prueba contextual: {e}")
        return False

def main():
    """Funci√≥n principal de prueba."""
    
    print("üöÄ Iniciando pruebas del sistema RAG-Anything mejorado...")
    print("=" * 60)
    
    # Ejecutar pruebas
    tests = [
        ("Sistema RAG-Anything completo", test_rag_anything_system),
        ("Procesamiento multimodal", test_multimodal_processing),
        ("Procesamiento contextual", test_context_awareness)
    ]
    
    results = []
    
    for test_name, test_func in tests:
        print(f"\nüß™ Ejecutando: {test_name}")
        print("-" * 40)
        
        try:
            success = test_func()
            results.append((test_name, success))
            
            if success:
                print(f"‚úÖ {test_name}: EXITOSO")
            else:
                print(f"‚ùå {test_name}: FALL√ì")
                
        except Exception as e:
            print(f"‚ùå {test_name}: ERROR - {e}")
            results.append((test_name, False))
    
    # Resumen de resultados
    print("\n" + "=" * 60)
    print("üìä RESUMEN DE PRUEBAS")
    print("=" * 60)
    
    passed = sum(1 for _, success in results if success)
    total = len(results)
    
    for test_name, success in results:
        status = "‚úÖ EXITOSO" if success else "‚ùå FALL√ì"
        print(f"{test_name}: {status}")
    
    print(f"\nüéØ Resultado final: {passed}/{total} pruebas exitosas")
    
    if passed == total:
        print("üéâ ¬°Todas las pruebas pasaron exitosamente!")
        print("üöÄ El sistema RAG-Anything est√° listo para usar")
    else:
        print("‚ö†Ô∏è  Algunas pruebas fallaron. Revisa los errores arriba.")
    
    return passed == total

if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)